<!DOCTYPE html>
<html>
  <head>
    <title>Shows</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>
  <style>
    .hidden {
      display: none;
    }
  </style>
  <body>
    <h1 id="showName"></h1>
    <h3 id="response"></h3>
    <h3 id="sqsCount"></h3>
    <form id="myForm" action="/order" method="POST">
      <div id="seatDataContainer"></div>
      <button type="submit">Submit</button>
    </form>
  </body>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");

    function generateRandomString(length) {
      const charset =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      const randomCodeArray = Array.from({ length: length }, () =>
        charset.charAt(Math.floor(Math.random() * charset.length))
      );
      return randomCodeArray.join("");
    }

    const randomString = generateRandomString(10);

    const data = {
      data: {
        id,
        randomString,
      },
    };

    console.log(data.data);

    const message = document.getElementById("response");

    const sendMessage = axios
      .post(
        "https://y91dhf3vh0.execute-api.ap-northeast-1.amazonaws.com/v1",
        data
      )
      .then((response) => {
        console.log(response);
        const MessageId =
          response.data.SendMessageResponse.SendMessageResult.MessageId;
        message.innerHTML = `Please Wait: ${MessageId}`;

        const sqs = axios.post("/checkSQS", { MessageId }).then((res) => {
          if (res.data.data > 0) {
            document.getElementById(
              "sqsCount"
            ).innerText = `您前面尚有 ${res.data.data} 個用戶`;
          } else {
            sqsCount.remove();
            message.remove();
          }
        });
      })
      .catch((error) => {
        console.error(error);
      });

    function fetchData() {
      const getSeatData = axios
        .post(
          `https://18jihetbil.execute-api.ap-northeast-1.amazonaws.com/prod/seat/${id}`,
          data
        )
        .then((response) => {
          console.log(response.data);
          console.log(response.data.data.checkKey);
          if (response.data.data.checkKey === 1) {
            const data = JSON.parse(response.data.showSeat);
            const seatDataContainer =
              document.getElementById("seatDataContainer");
            document.getElementById(
              "showName"
            ).innerHTML = `Show Name: ${data[0].name}`;
            data.forEach(function (seat) {
              const seatDiv = document.createElement("div");
              let checkboxInput = "";
              if (seat.status !== "NotReserved") {
                checkboxInput = `<input type="checkbox" name="seat" value="${seat.id}" disabled>`;
              }
              seatDiv.innerHTML = `
              <p>座位: ${seat.seat_row}${seat.seat_number}</p>
              <input type="checkbox" name="showSeatId" value="${seat.id}"
              ${checkboxInput}
              <input type="hidden" name="showId" value="${data[0].show_id}" />
              `;
              seatDataContainer.appendChild(seatDiv);
            });
            sqsCount.remove();
            message.remove();
          } else {
            setTimeout(fetchData, 1000);
          }
        })
        .catch((error) => {
          console.error(error);
        });
    }
    fetchData();

    const form = document.getElementById("myForm");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(form);
      const data = {
        showSeatId: formData.getAll("showSeatId"),
        showId: formData.get("showId"),
      };

      try {
        const res = await axios.post("/order", data);
        console.log(res);
        if (res.data === "sorry, no ticket") {
          alert("sorry, no ticket");
        } else {
          window.location.assign("/ticket/checkout");
        }
      } catch (err) {
        console.log(err);
      }
    });
  </script>
</html>
